{% extends "base.html" %}
{% block content %}

<div class="category-page">
  <h1>Select a Category</h1>

    <div class="quiz-settings">
    <h3>Select Number of Questions</h3>
    <div class="length-options">
      <button class="length-btn active" data-count="5">5</button>
      <button class="length-btn" data-count="10">10</button>
      <button class="length-btn" data-count="15">15</button>
    </div>
</div>

  <div class="category-progress">
    <h2>Your Performance</h2>
    <div id="progressContainer" class="progress-grid">
      <p class="muted">No attempts yet. Take a quiz to see stats.</p>
    </div>
  </div>

  <form id="quizForm">
  <div class="category-grid">
    {% for cat in categories %}
      <label class="category-card checkbox-card">
        <input type="checkbox" name="categories" value="{{ cat }}">
        <span>{{ cat }}</span>
      </label>
    {% endfor %}
  </div>

  <button type="submit" class="start-quiz-btn">
    Start Mixed Quiz
  </button>
</form>
</div>

<style>

</style>
<script>
let selectedCount = 5;

document.querySelectorAll('.length-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.length-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedCount = btn.dataset.count;
  });
});

document.getElementById("quizForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const selectedCats = [...document.querySelectorAll('input[name="categories"]:checked')]
    .map(cb => cb.value);

  if (selectedCats.length === 0) {
    alert("Select at least one category");
    return;
  }

  const params = new URLSearchParams();
  params.append("count", selectedCount);
  params.append("categories", selectedCats.join(","));

  window.location.href = `/quiz/mixed?${params.toString()}`;
});
</script>
<script>
const progressContainer = document.getElementById("progressContainer");
const progressData = JSON.parse(localStorage.getItem("quizProgress")) || {};

const bestCategory = Object.keys(progressData).reduce((best, cat) => {
  if (!best) return cat;
  return progressData[cat].best > progressData[best].best ? cat : best;
}, null);

const recommendedCategory = Object.keys(progressData).reduce((worst, cat) => {
  if (!worst) return cat;
  return progressData[cat].best < progressData[worst].best ? cat : worst;
}, null);

if (Object.keys(progressData).length > 0) {
  progressContainer.innerHTML = "";

  Object.keys(progressData).forEach(cat => {
    const data = progressData[cat];
    const card = document.createElement("div");
    card.className = "progress-card";
    if (cat === bestCategory) {
      card.classList.add("best-category");
    }
    if (cat === recommendedCategory && cat !== bestCategory) {
      card.classList.add("recommended-category");
    }
    const percent = data.attempts > 0 ? Math.round((data.best / 15) * 100) : 0;

    card.innerHTML = `
      <h4>${cat}</h4>
      <p>Attempts: ${data.attempts}</p>
      <p>Best Score: ${data.best}</p>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${percent}%"></div>
      </div>
      <p class="progress-label">${percent}% mastery</p>
      <button class="reset-btn" data-category="${cat}">Reset</button>
    `;
    progressContainer.appendChild(card);
  });

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("reset-btn")) {
      const cat = e.target.dataset.category;
      const progress = JSON.parse(localStorage.getItem("quizProgress")) || {};

      if (progress[cat]) {
        delete progress[cat];
        localStorage.setItem("quizProgress", JSON.stringify(progress));
        location.reload();
      }
    }
  });
}
</script>
{% endblock %}